<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Diego S. Cardoso">

<title>AGEC 652 - Lecture 6.3, part 2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="6_3b_MLE_discrete_choice_tutorial_files/libs/clipboard/clipboard.min.js"></script>
<script src="6_3b_MLE_discrete_choice_tutorial_files/libs/quarto-html/quarto.js"></script>
<script src="6_3b_MLE_discrete_choice_tutorial_files/libs/quarto-html/popper.min.js"></script>
<script src="6_3b_MLE_discrete_choice_tutorial_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="6_3b_MLE_discrete_choice_tutorial_files/libs/quarto-html/anchor.min.js"></script>
<link href="6_3b_MLE_discrete_choice_tutorial_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="6_3b_MLE_discrete_choice_tutorial_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="6_3b_MLE_discrete_choice_tutorial_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="6_3b_MLE_discrete_choice_tutorial_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="6_3b_MLE_discrete_choice_tutorial_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#course-roadmap" id="toc-course-roadmap" class="nav-link active" data-scroll-target="#course-roadmap">Course Roadmap</a></li>
  <li><a href="#main-references-for-today" id="toc-main-references-for-today" class="nav-link" data-scroll-target="#main-references-for-today">Main references for today</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#empirical-plan" id="toc-empirical-plan" class="nav-link" data-scroll-target="#empirical-plan">Empirical plan</a></li>
  <li><a href="#estimation" id="toc-estimation" class="nav-link" data-scroll-target="#estimation">1. Estimation</a>
  <ul class="collapse">
  <li><a href="#data-load" id="toc-data-load" class="nav-link" data-scroll-target="#data-load">Data load</a></li>
  <li><a href="#defining-beta" id="toc-defining-beta" class="nav-link" data-scroll-target="#defining-beta">Defining <span class="math inline">\(\beta\)</span></a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data preparation</a></li>
  <li><a href="#programming-the-estimator" id="toc-programming-the-estimator" class="nav-link" data-scroll-target="#programming-the-estimator">Programming the estimator</a></li>
  <li><a href="#estimating" id="toc-estimating" class="nav-link" data-scroll-target="#estimating">Estimating</a></li>
  <li><a href="#revising-the-estimation" id="toc-revising-the-estimation" class="nav-link" data-scroll-target="#revising-the-estimation">Revising the estimation</a></li>
  <li><a href="#revising-the-estimation-1" id="toc-revising-the-estimation-1" class="nav-link" data-scroll-target="#revising-the-estimation-1">Revising the estimation</a></li>
  <li><a href="#testing-the-restriction" id="toc-testing-the-restriction" class="nav-link" data-scroll-target="#testing-the-restriction">Testing the restriction</a></li>
  <li><a href="#bias" id="toc-bias" class="nav-link" data-scroll-target="#bias">Bias?</a></li>
  <li><a href="#calculating-standard-errors" id="toc-calculating-standard-errors" class="nav-link" data-scroll-target="#calculating-standard-errors">Calculating standard errors</a></li>
  <li><a href="#empirical-plan-1" id="toc-empirical-plan-1" class="nav-link" data-scroll-target="#empirical-plan-1">Empirical plan</a></li>
  </ul></li>
  <li><a href="#prediction" id="toc-prediction" class="nav-link" data-scroll-target="#prediction">2. Prediction</a>
  <ul class="collapse">
  <li><a href="#sanity-check" id="toc-sanity-check" class="nav-link" data-scroll-target="#sanity-check">Sanity check</a></li>
  <li><a href="#predicting-for-non-rail-cities" id="toc-predicting-for-non-rail-cities" class="nav-link" data-scroll-target="#predicting-for-non-rail-cities">Predicting for non-rail cities</a></li>
  <li><a href="#empirical-plan-2" id="toc-empirical-plan-2" class="nav-link" data-scroll-target="#empirical-plan-2">Empirical plan</a></li>
  </ul></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation">3. Interpretation</a>
  <ul class="collapse">
  <li><a href="#the-problem-with-raw-beta" id="toc-the-problem-with-raw-beta" class="nav-link" data-scroll-target="#the-problem-with-raw-beta">The problem with raw <span class="math inline">\(\beta\)</span></a></li>
  <li><a href="#marginal-effects" id="toc-marginal-effects" class="nav-link" data-scroll-target="#marginal-effects">Marginal effects</a></li>
  <li><a href="#marginal-effects-in-multinomial-logit" id="toc-marginal-effects-in-multinomial-logit" class="nav-link" data-scroll-target="#marginal-effects-in-multinomial-logit">Marginal effects in multinomial logit</a></li>
  <li><a href="#calculating-marginal-effects" id="toc-calculating-marginal-effects" class="nav-link" data-scroll-target="#calculating-marginal-effects">Calculating marginal effects</a></li>
  <li><a href="#empirical-plan-3" id="toc-empirical-plan-3" class="nav-link" data-scroll-target="#empirical-plan-3">Empirical plan</a></li>
  </ul></li>
  <li><a href="#willingness-to-pay" id="toc-willingness-to-pay" class="nav-link" data-scroll-target="#willingness-to-pay">4. Willingness to pay</a>
  <ul class="collapse">
  <li><a href="#defining-willingness-to-pay" id="toc-defining-willingness-to-pay" class="nav-link" data-scroll-target="#defining-willingness-to-pay">Defining willingness to pay</a></li>
  <li><a href="#empirical-plan-4" id="toc-empirical-plan-4" class="nav-link" data-scroll-target="#empirical-plan-4">Empirical plan</a></li>
  </ul></li>
  <li><a href="#welfare-consequences" id="toc-welfare-consequences" class="nav-link" data-scroll-target="#welfare-consequences">5. Welfare consequences</a>
  <ul class="collapse">
  <li><a href="#final-words" id="toc-final-words" class="nav-link" data-scroll-target="#final-words">Final words</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="6_3b_slides.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">AGEC 652 - Lecture 6.3, part 2</h1>
<p class="subtitle lead">Random Utility Models tutorial: estimation and analysis</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Diego S. Cardoso </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Purdue University
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  

</header>

<section id="course-roadmap" class="level2" data-background-color="gold">
<h2 data-background-color="gold" class="anchored" data-anchor-id="course-roadmap">Course Roadmap</h2>
<ol type="1">
<li><span class="gray">Introduction to Scientific Computing</span></li>
<li><span class="gray">Fundamentals of numerical methods</span></li>
<li><span class="gray">Systems of equations</span></li>
<li><span class="gray">Optimization</span></li>
<li><span class="gray">Structural estimation: Intro</span></li>
<li><strong>Maximum Likelihood Estimator</strong></li>
<li>Generalized Method of Moments</li>
<li>Simulation-based methods</li>
</ol>
</section>
<section id="main-references-for-today" class="level2" data-background-color="gold">
<h2 data-background-color="gold" class="anchored" data-anchor-id="main-references-for-today">Main references for today</h2>
<ul>
<li>The examples in this lecture are adapted from “Learning Microeconometrics with R”, by Christopher P. Adams (2021)</li>
<li>Theory: Cameron &amp; Trivedi (2008), Greene (2018)</li>
</ul>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<ul>
<li>In the first part of this tutorial we establish the economic model and generated simulation data from synthetic agents making transportation mode decisions</li>
<li>In this part, we will pretend we don’t know the true parameters of the model and will perform an empirical analysis of the data</li>
<li>We will estimate the parameters and use our estimated model to draw economic insights</li>
</ul>
<hr>
<ul>
<li>We can’t learn much about how individuals choose between trains and other transportation modes in cities currently without a rail system</li>
<li>But we also expect that the characteristics of individuals in cities with a rail system might not be exactly the same as those without a system</li>
<li>So our plan is to estimate a choice model based on the “rail cities” and use it to predict the mean behavior of individuals in “non-rail cities”</li>
</ul>
</section>
<section id="empirical-plan" class="level2" data-background-color="gold">
<h2 data-background-color="gold" class="anchored" data-anchor-id="empirical-plan">Empirical plan</h2>
<ol type="1">
<li>Estimate a discrete choice model based on the observed choices in rail cities</li>
<li>Use the estimated parameters to predict the mean choices on non-rail cities</li>
<li>Interpret the marginal effects and examine how different characteristics affect the probability of each choice</li>
<li>Estimate the willingness to pay for different modes and characteristics</li>
<li>Estimate the welfare gains/losses from introducing rail systems</li>
</ol>
</section>
<section id="estimation" class="level1">
<h1>1. Estimation</h1>
<section id="data-load" class="level2">
<h2 class="anchored" data-anchor-id="data-load">Data load</h2>
<p>We start by loading the data into memory.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CSV</span>, <span class="bu">DataFrames</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> CSV.<span class="fu">read</span>(<span class="st">"transportation_mode_survey.csv"</span>, DataFrame);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s again inspect the first few rows of this data.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(df[<span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, <span class="op">:</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>8×10 DataFrame
 Row │ city     price_bus  price_train  stops_bus  stops_train  density  hhsize  homeown  d_ib   d_it  
     │ String7  Float64    Float64      Int64      Int64        Float64  Int64   Int64    Int64  Int64 
─────┼─────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ nr_1          6.49          0.0         36            0     5.3        2        0      1      0
   2 │ nr_2          8.44          0.0         49            0     7.7        2        1      0      0
   3 │ nr_3          5.54          0.0         32            0     4.35       3        1      0      0
   4 │ nr_4          7.99          0.0         44            0     6.29       4        0      0      0
   5 │ nr_5          4.97          0.0         27            0     4.07       2        1      0      0
   6 │ nr_6          3.23          0.0         18            0     2.43       3        1      0      0
   7 │ nr_7          3.72          0.0         17            0     1.87       3        0      0      0
   8 │ nr_8          8.16          0.0         50            0     7.32       3        0      0      0</code></pre>
</div>
</div>
<hr>
<p>Since we want to perform an estimation only on rail cities, we can filter the rows we need from the data frame as follows</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df_r <span class="op">=</span> <span class="fu">filter</span>(row <span class="op">-&gt;</span> <span class="fu">startswith</span>(row[<span class="op">:</span>city], <span class="st">"r_"</span>), df);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="defining-beta" class="level2">
<h2 class="anchored" data-anchor-id="defining-beta">Defining <span class="math inline">\(\beta\)</span></h2>
<p>The discrete choice model we will estimate is the Random Utility Model we established in the first part of this tutorial. We will estimate the resulting discrete choice model using MLE.</p>
<p>Let’s then establish the parameter vectors <span class="math inline">\(\beta_b\)</span> and <span class="math inline">\(\beta_t\)</span>. Recall that each separate parameter vectors is a <span class="math inline">\(6 \times 1\)</span> vector indexed as follows</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Covariate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(\beta_0\)</span></td>
<td style="text-align: left;">Intercept</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(\beta_1\)</span></td>
<td style="text-align: left;"><code>price</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(\beta_2\)</span></td>
<td style="text-align: left;"><code>stops</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(\beta_3\)</span></td>
<td style="text-align: left;"><code>density</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(\beta_4\)</span></td>
<td style="text-align: left;"><code>hhsize</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(\beta_5\)</span></td>
<td style="text-align: left;"><code>homeown</code></td>
</tr>
</tbody>
</table>
<p>This way, we can regard the complete parameter vector <span class="math inline">\(\beta\)</span> as staking <span class="math inline">\(\beta_b\)</span> and <span class="math inline">\(\beta_t\)</span>, thus forming a <span class="math inline">\(12 \times 1\)</span> vector.</p>
</section>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data preparation</h2>
<p>We will assemble the <span class="math inline">\(X_b\)</span> and <span class="math inline">\(X_t\)</span> matrices so that its columns correspond to each individual parameter in <span class="math inline">\(\beta_b\)</span> and <span class="math inline">\(\beta_t\)</span>.</p>
<p>First, assemble a vector of ones with the same size as the number of observations.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>N_r <span class="op">=</span> <span class="fu">nrow</span>(df_r);</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ones_column <span class="op">=</span> <span class="fu">ones</span>(N_r);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, select the columns for bus and turn that into a matrix <span class="math inline">\(X_b\)</span> and add the column of ones for the intercept.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>X_b <span class="op">=</span> df_r[<span class="op">:</span>, [<span class="op">:</span>price_bus, <span class="op">:</span>stops_bus, <span class="op">:</span>density, <span class="op">:</span>hhsize, <span class="op">:</span>homeown]]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>X_b <span class="op">=</span> <span class="fu">Matrix</span>(X_b) <span class="co"># This converts the DataFrame into a matrix</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>X_b <span class="op">=</span> <span class="fu">hcat</span>(ones_column, X_b); <span class="co"># This concatenates the vector of 1s and X_b horizontally</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Take a peek:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>X_b[<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">:</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>5×6 Matrix{Float64}:
 1.0  6.49  36.0  5.3   3.0  1.0
 1.0  8.44  49.0  7.7   2.0  1.0
 1.0  5.54  32.0  4.35  3.0  1.0
 1.0  7.99  44.0  6.29  3.0  0.0
 1.0  4.97  27.0  4.07  3.0  0.0</code></pre>
</div>
</div>
<hr>
<p>Then, do the same for <span class="math inline">\(X_t\)</span></p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>X_t <span class="op">=</span> df_r[<span class="op">:</span>, [<span class="op">:</span>price_train, <span class="op">:</span>stops_train, <span class="op">:</span>density, <span class="op">:</span>hhsize, <span class="op">:</span>homeown]]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>X_t <span class="op">=</span> <span class="fu">Matrix</span>(X_t)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>X_t <span class="op">=</span> <span class="fu">hcat</span>(ones_column, X_t);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>Finally, we also want to form our vector of outcomes <span class="math inline">\(d_b\)</span> and <span class="math inline">\(d_t\)</span>.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>d_b <span class="op">=</span> <span class="fu">Matrix</span>(df_r[<span class="op">:</span>, [<span class="op">:</span>d_ib]]);</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>d_t <span class="op">=</span> <span class="fu">Matrix</span>(df_r[<span class="op">:</span>, [<span class="op">:</span>d_it]]);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="programming-the-estimator" class="level2">
<h2 class="anchored" data-anchor-id="programming-the-estimator">Programming the estimator</h2>
<p>We are now ready to program our estimator. Recall that the MLE for the Multinomial Logit model is given by</p>
<p><span class="math display">\[
l(\beta) = \sum_{i=1}^N \sum_{k=1}^K d_{ik} \log Pr[y_i = k | X_i] = \sum_{i=1}^N \sum_{k=1}^K d_{ik} (X_{ik}^\prime \beta_k) - \sum_{i=1}^N \log \left(\sum_{k=1}^K e^{X_{ik}^\prime \beta_k}\right)
\]</span></p>
<p>Since <span class="math inline">\(\beta\)</span> is unconstrained, we can use <code>Optim</code> to solve this optimization problem. Therefore, to can program the negative of the <span class="math inline">\(l\)</span> function (remember that <code>Optim</code> solves only minimization problems).</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">neg_log_likelihood</span>(β; X_b <span class="op">=</span> X_b, X_t <span class="op">=</span> X_t, d_b <span class="op">=</span> d_b, d_t <span class="op">=</span> d_t)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unpack separate vector of parameters</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    β_b <span class="op">=</span> β[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    β_t <span class="op">=</span> β[<span class="fl">7</span><span class="op">:</span><span class="fl">12</span>]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate V_ik = X_ik * β_k</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    V_ib <span class="op">=</span> X_b <span class="op">*</span> β_b <span class="co"># Note that his is a matrix multiplication</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    V_it <span class="op">=</span> X_t <span class="op">*</span> β_t <span class="co"># And this one, too</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the denominator of the probabilities (the 2nd term in l)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    log_denom <span class="op">=</span> <span class="fu">log</span>.(<span class="fl">1.0</span> <span class="op">.+</span> <span class="fu">exp</span>.(V_ib) <span class="op">.+</span> <span class="fu">exp</span>.(V_it))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the whole l</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    neg_l <span class="op">=</span> <span class="fu">-sum</span>(d_b <span class="op">.*</span> V_ib <span class="op">.+</span> d_t <span class="op">.*</span> V_it <span class="op">.-</span> log_denom)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> neg_l</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>neg_log_likelihood (generic function with 1 method)</code></pre>
</div>
</div>
<hr>
<p>Let’s try out this function with the vector of true <span class="math inline">\(\beta\)</span></p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>true_β_b <span class="op">=</span> [<span class="op">-</span><span class="fl">1.0</span>, <span class="op">-</span><span class="fl">0.8</span>,  <span class="fl">0.1</span>,  <span class="fl">0.3</span>, <span class="op">-</span><span class="fl">0.2</span>, <span class="op">-</span><span class="fl">0.3</span>];</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>true_β_t <span class="op">=</span> [<span class="op">-</span><span class="fl">0.6</span>, <span class="op">-</span><span class="fl">0.8</span>,  <span class="fl">0.2</span>,  <span class="fl">0.6</span>, <span class="op">-</span><span class="fl">0.1</span>, <span class="op">-</span><span class="fl">0.2</span>];</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>true_β <span class="op">=</span> <span class="fu">vcat</span>(true_β_b, true_β_t);</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">-neg_log_likelihood</span>(true_β)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>-32662.007134423682</code></pre>
</div>
</div>
<p>What if we give it a <span class="math inline">\(\beta = 0\)</span></p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">-neg_log_likelihood</span>(<span class="fu">zeros</span>(<span class="fl">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>-65916.73732008654</code></pre>
</div>
</div>
<p>It has a much smaller value, so definitely not the our MLE estimates!</p>
</section>
<section id="estimating" class="level2">
<h2 class="anchored" data-anchor-id="estimating">Estimating</h2>
<p>Next, we can use <code>Optim</code> to solve the optimization for us.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Optim</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's give it a vector of zeros for the initial guess</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="fu">optimize</span>(neg_log_likelihood, <span class="fu">zeros</span>(<span class="fl">12</span>), <span class="fu">BFGS</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code> * Status: success

 * Candidate solution
    Final objective value:     3.212633e+04

 * Found with
    Algorithm:     BFGS

 * Convergence measures
    |x - x'|               = 9.99e-10 ≰ 0.0e+00
    |x - x'|/|x'|          = 7.97e-10 ≰ 0.0e+00
    |f(x) - f(x')|         = 0.00e+00 ≤ 0.0e+00
    |f(x) - f(x')|/|f(x')| = 0.00e+00 ≤ 0.0e+00
    |g(x)|                 = 9.91e-06 ≰ 1.0e-08

 * Work counters
    Seconds run:   6  (vs limit Inf)
    Iterations:    24
    f(x) calls:    115
    ∇f(x) calls:   115</code></pre>
</div>
</div>
<p>Let’s check the minimum value it attains</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>res.minimum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>32126.33295639354</code></pre>
</div>
</div>
<hr>
<p>It’s a good practice to check if our optimization is sensitive to the initial guess, so we can be more confident that our estimates are reliable</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>res_1 <span class="op">=</span> <span class="fu">optimize</span>(neg_log_likelihood, <span class="fu">ones</span>(<span class="fl">12</span>), <span class="fu">BFGS</span>());</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>res_1.minimum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>32126.33295639354</code></pre>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>res_2 <span class="op">=</span> <span class="fu">optimize</span>(neg_log_likelihood, <span class="fl">2</span><span class="fu">*ones</span>(<span class="fl">12</span>), <span class="fu">BFGS</span>());</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>res_2.minimum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>32126.332956393537</code></pre>
</div>
</div>
<p>OK, these are all pretty close. So let’s stick with the first one for our main estimate.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>β_MLE <span class="op">=</span> res.minimizer;</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>β_MLE<span class="ch">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>1×12 adjoint(::Vector{Float64}) with eltype Float64:
 -1.25302  -0.981234  0.109963  0.486675  …  0.744581  -0.13079  -0.215491</code></pre>
</div>
</div>
</section>
<section id="revising-the-estimation" class="level2">
<h2 class="anchored" data-anchor-id="revising-the-estimation">Revising the estimation</h2>
<p>There’s a theoretical problem here, though</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>β_MLE[<span class="fl">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>-0.9812342431109393</code></pre>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>β_MLE[<span class="fl">8</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>-0.9591216015843176</code></pre>
</div>
</div>
<p>We would expect the price coefficients to be the same, because they represent the marginal utility of income. (Later we will need this parameter for welfare analysis). But random noise in the data prevents us from getting exactly the same estimates.</p>
</section>
<section id="revising-the-estimation-1" class="level2">
<h2 class="anchored" data-anchor-id="revising-the-estimation-1">Revising the estimation</h2>
<p>We can revise our estimation procedure to estimate a restricted model where we will enforce <span class="math inline">\(\beta_{b,1} = \beta_{t,1}\)</span>. To do that, we program an estimator for the restricted model.</p>
<p>In this case, <span class="math inline">\(\beta\)</span> now has only 11 elements, and we will reuse the price coefficient of <span class="math inline">\(\beta_b\)</span> for <span class="math inline">\(\beta_t\)</span>.</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">restr_neg_log_likelihood</span>(β; X_b <span class="op">=</span> X_b, X_t <span class="op">=</span> X_t, d_b <span class="op">=</span> d_b, d_t <span class="op">=</span> d_t)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We just take element 2 in β and insert it again between elements 7 and 8</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    β_b <span class="op">=</span> β[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>] <span class="co"># The usual</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    β_t <span class="op">=</span> <span class="fu">vcat</span>(β[<span class="fl">7</span>], β[<span class="fl">2</span>], β[<span class="fl">8</span><span class="op">:</span><span class="fl">11</span>]) <span class="co"># Repeat the price coefficient</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stack it again</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    β_restricted <span class="op">=</span> <span class="fu">vcat</span>(β_b, β_t) </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The rest is like the previous one, so we can just call our other function!</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    neg_l <span class="op">=</span> <span class="fu">neg_log_likelihood</span>(β_restricted; X_b <span class="op">=</span> X_b, X_t <span class="op">=</span> X_t, d_b <span class="op">=</span> d_b, d_t <span class="op">=</span> d_t)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> neg_l</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>restr_neg_log_likelihood (generic function with 1 method)</code></pre>
</div>
</div>
<hr>
<p>Run the optimization/estimation!</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>res_restr <span class="op">=</span> <span class="fu">optimize</span>(restr_neg_log_likelihood, <span class="fu">zeros</span>(<span class="fl">11</span>), <span class="fu">BFGS</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code> * Status: success

 * Candidate solution
    Final objective value:     3.212641e+04

 * Found with
    Algorithm:     BFGS

 * Convergence measures
    |x - x'|               = 0.00e+00 ≤ 0.0e+00
    |x - x'|/|x'|          = 0.00e+00 ≤ 0.0e+00
    |f(x) - f(x')|         = 0.00e+00 ≤ 0.0e+00
    |f(x) - f(x')|/|f(x')| = 0.00e+00 ≤ 0.0e+00
    |g(x)|                 = 1.20e-06 ≰ 1.0e-08

 * Work counters
    Seconds run:   7  (vs limit Inf)
    Iterations:    35
    f(x) calls:    136
    ∇f(x) calls:   136</code></pre>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>β_MLE_restr <span class="op">=</span> res_restr.minimizer;</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>β_MLE_restr<span class="ch">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">
<pre><code>1×11 adjoint(::Vector{Float64}) with eltype Float64:
 -1.26834  -0.962045  0.10644  0.49067  …  0.744867  -0.130826  -0.215556</code></pre>
</div>
</div>
</section>
<section id="testing-the-restriction" class="level2">
<h2 class="anchored" data-anchor-id="testing-the-restriction">Testing the restriction</h2>
<p>Is this restriction empirically sensible? We know how to test it! We can use the LR test, for example, with a null hypothesis that <span class="math inline">\(\beta_{b,1} = \beta_{t,1}\)</span>. Recall</p>
<p><span class="math display">\[
LR = 2 \left(l(\hat{\beta}_U) - l(\hat{\beta}_R) \right) \sim \chi^2_{1}
\]</span></p>
<p>Luckily, we already have the value of the objective function for each of those cases stored for us the optimization results, so this test statistic is easy to calculate!</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>l_U <span class="op">=</span> <span class="op">-</span>res.minimum;</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>l_R <span class="op">=</span> <span class="op">-</span>res_restr.minimum;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>LR_stat <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> (l_U <span class="op">-</span> l_R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>0.15121039505902445</code></pre>
</div>
</div>
<hr>
<p>It’s also easy calculate the critical value for this test using the quantile of the <span class="math inline">\(\chi^2_{1}\)</span> distribution with <span class="math inline">\(\alpha = 0.05\)</span></p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributions</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>crit_value <span class="op">=</span> <span class="fu">quantile</span>(<span class="fu">Chisq</span>(<span class="fl">1</span>), <span class="fl">0.95</span>);</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Critical value: </span><span class="sc">$</span>crit_value<span class="st"> . Test statistic: </span><span class="sc">$</span>LR_stat<span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Critical value: 3.8414588206941245 . Test statistic: 0.15121039505902445</code></pre>
</div>
</div>
<p>Thus, we cannot reject the null hypothesis. We will stick with the restricted estimate as our main estimate now.</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>β_b_hat <span class="op">=</span> β_MLE_restr[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>]; <span class="co"># The usual</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>β_t_hat <span class="op">=</span> <span class="fu">vcat</span>(β_MLE_restr[<span class="fl">7</span>], β_MLE_restr[<span class="fl">2</span>], β_MLE_restr[<span class="fl">8</span><span class="op">:</span><span class="fl">11</span>]); <span class="co"># Repeat the price coefficient</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>β_hat <span class="op">=</span> <span class="fu">vcat</span>(β_b_hat, β_t_hat);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="bias" class="level2">
<h2 class="anchored" data-anchor-id="bias">Bias?</h2>
<p>Let’s now compare our estimates with the true values.</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>true_β<span class="op">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>1×12 adjoint(::Vector{Float64}) with eltype Float64:
 -1.0  -0.8  0.1  0.3  -0.2  -0.3  -0.6  -0.8  0.2  0.6  -0.1  -0.2</code></pre>
</div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>β_hat<span class="ch">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>1×12 adjoint(::Vector{Float64}) with eltype Float64:
 -1.26834  -0.962045  0.10644  0.49067  …  0.744867  -0.130826  -0.215556</code></pre>
</div>
</div>
<p>Looks like we got a significant bias here… All coefficients are larger in absolute value! Is this some kind of bias?</p>
<hr>
<p>Nope! Remember, <span class="math inline">\(\beta\)</span> is not identified! We can only estimate <span class="math inline">\(\beta/\sigma\)</span>, but in the MLE estimation, we assumed <span class="math inline">\(\sigma = 1\)</span>.</p>
<p>We know that the true value of <span class="math inline">\(\sigma\)</span> was <span class="math inline">\(0.8\)</span>. Let’s compare our estimates with the true <span class="math inline">\(\beta/\sigma\)</span>.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>true_β<span class="op">'./</span><span class="fl">0.8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>1×12 Matrix{Float64}:
 -1.25  -1.0  0.125  0.375  -0.25  -0.375  …  -1.0  0.25  0.75  -0.125  -0.25</code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>β_hat<span class="ch">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>1×12 adjoint(::Vector{Float64}) with eltype Float64:
 -1.26834  -0.962045  0.10644  0.49067  …  0.744867  -0.130826  -0.215556</code></pre>
</div>
</div>
<p>Not perfect, but they align a lot closer now.</p>
</section>
<section id="calculating-standard-errors" class="level2">
<h2 class="anchored" data-anchor-id="calculating-standard-errors">Calculating standard errors</h2>
<p>We know how to calculate asymptotic standard errors for the MLE using numerical differentiation.</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ForwardDiff</span>, <span class="bu">LinearAlgebra</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>Im <span class="op">=</span> <span class="op">-</span>ForwardDiff.<span class="fu">hessian</span>(restr_neg_log_likelihood, β_MLE_restr) <span class="co"># Flip the signs</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>V <span class="op">=</span> <span class="fu">inv</span>(Im);</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>SEs <span class="op">=</span> <span class="fu">sqrt</span>.(<span class="fu">diag</span>(<span class="op">-</span>V));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>And we can organize our results in a classic estimates table</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>res_df <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  Coefficient <span class="op">=</span> [<span class="st">"β_b0"</span>, <span class="st">"β_b1=β_t1"</span>, <span class="st">"β_b2"</span>, <span class="st">"β_b3"</span>, <span class="st">"β_b4"</span>, <span class="st">"β_b5"</span>, <span class="st">"β_t0"</span>, <span class="st">"β_t2"</span>, <span class="st">"β_t3"</span>, <span class="st">"β_t4"</span>, <span class="st">"β_t5"</span>],</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  Estimate <span class="op">=</span> β_MLE_restr,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  StdError <span class="op">=</span> SEs,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  CI_lower <span class="op">=</span> β_MLE_restr <span class="op">.+</span> <span class="fu">quantile</span>(<span class="fu">Normal</span>(), <span class="fl">0.025</span>) <span class="op">.*</span> SEs,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  CI_upper <span class="op">=</span> β_MLE_restr <span class="op">.+</span> <span class="fu">quantile</span>(<span class="fu">Normal</span>(), <span class="fl">0.975</span>) <span class="op">.*</span> SEs</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(res_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>11×5 DataFrame
 Row │ Coefficient  Estimate   StdError    CI_lower    CI_upper  
     │ String       Float64    Float64     Float64     Float64   
─────┼───────────────────────────────────────────────────────────
   1 │ β_b0         -1.26834   0.0649339   -1.3956     -1.14107
   2 │ β_b1=β_t1    -0.962045  0.01838     -0.998069   -0.926021
   3 │ β_b2          0.10644   0.00857776   0.0896282   0.123252
   4 │ β_b3          0.49067   0.0473282    0.397908    0.583432
   5 │ β_b4         -0.256119  0.012644    -0.280901   -0.231337
   6 │ β_b5         -0.385548  0.0284063   -0.441223   -0.329873
   7 │ β_t0         -0.741272  0.0818007   -0.901598   -0.580946
   8 │ β_t2          0.236894  0.00857381   0.22009     0.253698
   9 │ β_t3          0.744867  0.0096659    0.725923    0.763812
  10 │ β_t4         -0.130826  0.0125632   -0.15545    -0.106203
  11 │ β_t5         -0.215556  0.0301444   -0.274638   -0.156474</code></pre>
</div>
</div>
</section>
<section id="empirical-plan-1" class="level2" data-background-color="gold">
<h2 data-background-color="gold" class="anchored" data-anchor-id="empirical-plan-1">Empirical plan</h2>
<ol type="1">
<li><span class="gray">Estimate a discrete choice model based on the observed choices in rail cities</span></li>
<li><strong>Use the estimated parameters to predict the mean choices on non-rail cities</strong></li>
<li>Interpret the marginal effects and examine how different characteristics affect the probability of each choice</li>
<li>Estimate the willingness to pay for different modes and characteristics</li>
<li>Estimate the welfare gains/losses from introducing rail systems</li>
</ol>
</section>
</section>
<section id="prediction" class="level1">
<h1>2. Prediction</h1>
<section id="sanity-check" class="level2">
<h2 class="anchored" data-anchor-id="sanity-check">Sanity check</h2>
<p>Before thinking about the non-rail cities, let’s assess how well our model is predicting the mean choices in the same sample we used to estimate the model.</p>
<p>That’s easy to do: just apply the parameters to the same <span class="math inline">\(X_b\)</span> and <span class="math inline">\(X_t\)</span>. Recall</p>
<p><span class="math display">\[
Pr[y_i = k | X_i] = \frac{e^{X_{ik}^\prime \beta_k}}{\sum_{j=1}^J e^{X_{ij}^\prime \beta_j}} = \frac{e^{V_{ik}}}{\sum_{j=1}^J e^{V_{ij}}}
\]</span></p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>V_b_hat <span class="op">=</span> X_b <span class="op">*</span> β_hat[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>];</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>V_t_hat <span class="op">=</span> X_t <span class="op">*</span> β_hat[<span class="fl">7</span><span class="op">:</span><span class="fl">12</span>];</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The denominator is the same for all options</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>denom_r <span class="op">=</span> <span class="fl">1.0</span> <span class="op">.+</span> <span class="fu">exp</span>.(V_b_hat) <span class="op">.+</span> <span class="fu">exp</span>.(V_t_hat);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>Calculating the probabilities for each observation</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>prob_b_r <span class="op">=</span> <span class="fu">exp</span>.(V_b_hat) <span class="op">./</span> denom_r;</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>prob_t_r <span class="op">=</span> <span class="fu">exp</span>.(V_t_hat) <span class="op">./</span> denom_r;</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>prob_c_r <span class="op">=</span> <span class="fl">1.0</span> <span class="op">.-</span> prob_b_r <span class="op">.-</span> prob_t_r;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So the predicted mean (or expected) probability of chosing the bus is</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Statistics</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>mean_prob_b_r <span class="op">=</span> <span class="fu">mean</span>(prob_b_r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>0.09985000000032383</code></pre>
</div>
</div>
<p>How does this compare to the observed share of bus riders?</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(d_b)<span class="op">/</span>N_r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>0.09985</code></pre>
</div>
</div>
<p>Pretty good prediction!</p>
<hr>
<p>How about for the train?</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>mean_prob_t_r <span class="op">=</span> <span class="fu">mean</span>(prob_t_r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>0.13886666666597253</code></pre>
</div>
</div>
<p>How does this compare to the observed share of bus riders?</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(d_t)<span class="op">/</span>N_r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>0.13886666666666667</code></pre>
</div>
</div>
<p>Also spot on!</p>
</section>
<section id="predicting-for-non-rail-cities" class="level2">
<h2 class="anchored" data-anchor-id="predicting-for-non-rail-cities">Predicting for non-rail cities</h2>
<p>This sanity check helped us see how we can perform the same exercise, but now using the <span class="math inline">\(X\)</span> matrices for non-rail cities.</p>
<p>We can assemble those matrices the same way we did for rail cities.</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for nr cities</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>df_nr <span class="op">=</span> <span class="fu">filter</span>(row <span class="op">-&gt;</span> <span class="fu">startswith</span>(row[<span class="op">:</span>city], <span class="st">"nr_"</span>), df);</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>N_nr <span class="op">=</span> <span class="fu">nrow</span>(df_nr);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Assemble <span class="math inline">\(X_b\)</span> for non-rail</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we are combining a few steps at once</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>X_b_nr <span class="op">=</span> <span class="fu">Matrix</span>(df_nr[<span class="op">:</span>, [<span class="op">:</span>price_bus, <span class="op">:</span>stops_bus, <span class="op">:</span>density, <span class="op">:</span>hhsize, <span class="op">:</span>homeown]]);</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>X_b_nr <span class="op">=</span> <span class="fu">hcat</span>(<span class="fu">ones</span>(<span class="fu">nrow</span>(df_nr)), X_b_nr);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>Next, we need to assemble <span class="math inline">\(X_t\)</span>. However, we must make a choice: these cities don’t have rail prices or number of stops… For what kind of rail system do we want to predict?</p>
<p>One option is to predict for a system that</p>
<ul>
<li>Has a price that is 10% higher than the currently observed bus prices</li>
<li>Has exactly 10 train stops (so an initially small network)</li>
</ul>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>X_t_nr <span class="op">=</span> df_nr[<span class="op">:</span>, [<span class="op">:</span>price_bus, <span class="op">:</span>stops_train, <span class="op">:</span>density, <span class="op">:</span>hhsize, <span class="op">:</span>homeown]];</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>X_t_nr.price_bus <span class="op">=</span> <span class="fl">1.1</span> <span class="op">.*</span> X_t_nr.price_bus; <span class="co"># 5% more expensive</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>X_t_nr.stops_train <span class="op">=</span> <span class="fl">10</span> <span class="op">.*</span> <span class="fu">ones</span>(N_nr); <span class="co"># 10 stops</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>X_t_nr <span class="op">=</span> <span class="fu">Matrix</span>(X_t_nr);</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>X_t_nr <span class="op">=</span> <span class="fu">hcat</span>(<span class="fu">ones</span>(N_nr), X_t_nr);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>We can proceed with the calculation of probabilities like in the rail case.</p>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>V_b_hat_nr <span class="op">=</span> X_b_nr <span class="op">*</span> β_hat[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>];</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>V_t_hat_nr <span class="op">=</span> X_t_nr <span class="op">*</span> β_hat[<span class="fl">7</span><span class="op">:</span><span class="fl">12</span>];</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The denominator is the same for all options</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>denom_nr <span class="op">=</span> <span class="fl">1.0</span> <span class="op">.+</span> <span class="fu">exp</span>.(V_b_hat_nr) <span class="op">.+</span> <span class="fu">exp</span>.(V_t_hat_nr);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>prob_b_nr <span class="op">=</span> <span class="fu">exp</span>.(V_b_hat_nr) <span class="op">./</span> denom_nr;</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>prob_t_nr <span class="op">=</span> <span class="fu">exp</span>.(V_t_hat_nr) <span class="op">./</span> denom_nr;</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>prob_c_nr <span class="op">=</span> <span class="fl">1.0</span> <span class="op">.-</span> prob_b_nr <span class="op">.-</span> prob_t_nr;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>Finally, we calculate the predicted mean (expected) probabilities of each choice</p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>mean_prob_b_nr <span class="op">=</span> <span class="fu">mean</span>(prob_b_nr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>0.09041621616633082</code></pre>
</div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>mean_prob_t_nr <span class="op">=</span> <span class="fu">mean</span>(prob_t_nr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>0.14923985762722458</code></pre>
</div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>mean_prob_c_nr <span class="op">=</span> <span class="fu">mean</span>(prob_c_nr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>0.7603439262064445</code></pre>
</div>
</div>
<p>So, about 9% for bus, 15% for train, and 76% for cars!</p>
<p>As in the BART case, the predicted train ridership is below that of the survey. But, of course, we could play with different train prices and stops to have different predicted probabilities.</p>
</section>
<section id="empirical-plan-2" class="level2" data-background-color="gold">
<h2 data-background-color="gold" class="anchored" data-anchor-id="empirical-plan-2">Empirical plan</h2>
<ol type="1">
<li><span class="gray">Estimate a discrete choice model based on the observed choices in rail cities</span></li>
<li><span class="gray">Use the estimated parameters to predict the mean choices on non-rail cities</span></li>
<li><strong>Interpret the marginal effects and examine how different characteristics affect the probability of each choice</strong></li>
<li>Estimate the willingness to pay for different modes and characteristics</li>
<li>Estimate the welfare gains/losses from introducing rail systems</li>
</ol>
</section>
</section>
<section id="interpretation" class="level1">
<h1>3. Interpretation</h1>
<section id="the-problem-with-raw-beta" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-with-raw-beta">The problem with raw <span class="math inline">\(\beta\)</span></h2>
<p>The raw <span class="math inline">\(\beta\)</span> coefficients in non-linear discrete choice models are hard to interpret.</p>
<ul>
<li>First, because these coefficients map observed characteristics to the latent variable, which is not very intuitive.</li>
<li>Second, because the <span class="math inline">\(\beta\)</span> themselves are divided by some non-identifiable <span class="math inline">\(\sigma\)</span>, so their absolute value has little meaning.</li>
<li>Third, because unlike linear regressions, the marginal effect of some variable change in <span class="math inline">\(x_j\)</span> on <span class="math inline">\(Y\)</span> is not just <span class="math inline">\(\beta_j\)</span>.</li>
</ul>
<p>For these reasons, we typically opt to interpret the calculated marginal effects implied by our estimates.</p>
</section>
<section id="marginal-effects" class="level2">
<h2 class="anchored" data-anchor-id="marginal-effects">Marginal effects</h2>
<p>In the context of a discrete choice model, the marginal effect of a continuous covariate <span class="math inline">\(x_a\)</span> is given by</p>
<p><span class="math display">\[
\frac{\partial \Pr[Y = k | X]}{\partial x_a}
\]</span></p>
<p>But what <span class="math inline">\(X\)</span> do we choose? In linear models, it doesn’t really matter because the marginal effect is determined by linear parameters, so <span class="math display">\[
E\left[\frac{\partial E[Y|X]}{\partial x_a}\right] = \frac{\partial E[Y|E[X]]}{\partial x_a} = \beta_a
\]</span></p>
<p>But in nonlinear models, that equality does not hold!</p>
<hr>
<p>Here, we have two options:</p>
<ol type="1">
<li>Calculate the mean marginal effect: <span class="math inline">\(E\left[\frac{\partial \Pr[Y = k | X]}{\partial x_a}\right]\)</span></li>
<li>Calculate mean marginal effect on the mean: <span class="math inline">\(\frac{\partial \Pr[Y = k | E[X]]}{\partial x_a}\)</span></li>
</ol>
<p>While there is no single right approach, option 1 is typically preferred because</p>
<ul>
<li>It averages out across your sample, so it’s reflective of your observations.</li>
<li>Sometimes an “average individual” (i.e., one with all characteristics at the sample average) is implausible or not an interesting case.</li>
</ul>
</section>
<section id="marginal-effects-in-multinomial-logit" class="level2">
<h2 class="anchored" data-anchor-id="marginal-effects-in-multinomial-logit">Marginal effects in multinomial logit</h2>
<p>For the multinomial logit case, we have a closed-form expression of the marginal effect.</p>
<p>For a simpler notation, let <span class="math inline">\(p_{ik} = \Pr[Y_i = k | X_i]\)</span>. Then, the marginal effect on choice <span class="math inline">\(k\)</span> for a change in the vector of characteristics of choice <span class="math inline">\(j\)</span> is given by</p>
<p><span class="math display">\[
\frac{\partial p_{ik}}{\partial X_{ij}} =  p_{ik}(\delta_{ikj} - p_{ij})\beta
\]</span></p>
<p>where <span class="math inline">\(\delta_{ijk} = 1\)</span> if <span class="math inline">\(j=k\)</span> (“own” marginal effect) or <span class="math inline">\(0\)</span> otherwise (“cross” marginal effect).</p>
<hr>
<p>For example, the marginal effect of the number of train stops (mapped to <span class="math inline">\(\beta_{t,2}\)</span>) on the probability of choosing train is given by</p>
<p><span class="math display">\[
\frac{\partial p_{it}}{\partial x_{it,2}} =  p_{it}(1 - p_{it})\beta_{t,2}
\]</span></p>
<p>Similarly, the marginal effect of the same variable on the probability of choosing bus is</p>
<p><span class="math display">\[
\frac{\partial p_{ib}}{\partial x_{it,2}} =  p_{ib}(0 - p_{it})\beta_{t,2} = -p_{ib}p_{it}\beta_{t,2}
\]</span></p>
<p>Let’s use these formulas to calculate the mean marginal effect of train prices and the number of stops.</p>
</section>
<section id="calculating-marginal-effects" class="level2">
<h2 class="anchored" data-anchor-id="calculating-marginal-effects">Calculating marginal effects</h2>
<p>Let’s use these formulas to calculate the average marginal effect of train stops.</p>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>mg_effect_t_trainstops <span class="op">=</span> prob_t_nr <span class="op">.*</span> (<span class="fl">1.0</span> <span class="op">.-</span> prob_t_nr) <span class="op">.*</span> β_t_hat[<span class="fl">3</span>]; <span class="co"># Index 3 because we start from zero</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>mg_effect_b_trainstops <span class="op">=</span> <span class="op">-</span>prob_b_nr <span class="op">.*</span> prob_t_nr <span class="op">.*</span> β_t_hat[<span class="fl">3</span>];</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"AME of train stops on prob. of train: </span><span class="sc">$</span>(<span class="fu">mean</span>(mg_effect_t_trainstops))<span class="st">.</span><span class="sc">\n</span><span class="st"> And on prob. of bus: </span><span class="sc">$</span>(<span class="fu">mean</span>(mg_effect_b_trainstops))<span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AME of train stops on prob. of train: 0.028873530257323067.
 And on prob. of bus: -0.002914283110489992</code></pre>
</div>
</div>
<p>So, raising the number of stops from 10 to 11 would increase the share of train riders by about 2.8 percentage points (pp)! It would also reduce the number of bus riders by about 0.29 pp, so little substitution would happen.</p>
<ul>
<li>You could also use a numerical method to calculate these derivatives. In that case, you would need to do that for each observation then average the derivatives.</li>
</ul>
<hr>
<p>We can do a similar exercise with the marginal effect of train prices.</p>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>mg_effect_t_trainprice <span class="op">=</span> prob_t_nr <span class="op">.*</span> (<span class="fl">1.0</span> <span class="op">.-</span> prob_t_nr) <span class="op">.*</span> β_t_hat[<span class="fl">2</span>]; <span class="co"># Index 2 because we start from zero</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>mg_effect_b_trainprice <span class="op">=</span> <span class="op">-</span>prob_b_nr <span class="op">.*</span> prob_t_nr <span class="op">.*</span> β_t_hat[<span class="fl">2</span>];</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"AME of train prices on prob. of train: </span><span class="sc">$</span>(<span class="fu">mean</span>(mg_effect_t_trainprice))<span class="st">.</span><span class="sc">\n</span><span class="st"> And on prob. of bus: </span><span class="sc">$</span>(<span class="fu">mean</span>(mg_effect_b_trainprice))<span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AME of train prices on prob. of train: -0.1172576271964368.
 And on prob. of bus: 0.011835127865185044</code></pre>
</div>
</div>
<p>So, increasing the price of trains by 1 (hundred dollars), would drop its ridership by a lot and increase bus ridership by about 1 pp.</p>
<hr>
<p>Since we are dealing with marginal effects of price on demand, it’s easy to calculate elasticities, too!</p>
<ul>
<li>Recall that the price elasticity of demand is defined as <span class="math inline">\(\frac{\partial Q}{\partial P} \frac{P}{Q}\)</span></li>
<li>Also, in expectation, the probability of a choice represents the market share of that choice.
<ul>
<li>In other words, the expected number of riders of trains among the N surveyed individuals is <span class="math inline">\(E[Q] = N \times \Pr[y = t]\)</span></li>
<li>But the expected market share is <span class="math inline">\(E[Q]/N = \Pr[y = t]\)</span></li>
</ul></li>
</ul>
<p>Therefore,</p>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>trainprices <span class="op">=</span> X_t_nr[<span class="op">:</span>,<span class="fl">2</span>] <span class="co"># Second column in X_t </span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>elast_t_trainprice <span class="op">=</span>  (<span class="fl">1.0</span> <span class="op">.-</span> prob_t_nr) <span class="op">.*</span> β_t_hat[<span class="fl">2</span>] <span class="op">.*</span> trainprices; <span class="co"># Since we divide by q, own probability drops out</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>elast_b_trainprice <span class="op">=</span> <span class="op">-</span>prob_t_nr <span class="op">.*</span> β_t_hat[<span class="fl">2</span>] <span class="op">.*</span> trainprices;</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"The mean elasticity of train demand w.r.t. train prices is: </span><span class="sc">$</span>(<span class="fu">mean</span>(elast_t_trainprice))<span class="st">.</span><span class="sc">\n</span><span class="st"> And for bus demand w.r.t. train prices is: </span><span class="sc">$</span>(<span class="fu">mean</span>(elast_b_trainprice))<span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The mean elasticity of train demand w.r.t. train prices is: -5.224014778997108.
 And for bus demand w.r.t. train prices is: 0.7967204616977237</code></pre>
</div>
</div>
<p>That’s a pretty high own price elasticity in absolute terms. (Probably too high to be realistic…)</p>
</section>
<section id="empirical-plan-3" class="level2" data-background-color="gold">
<h2 data-background-color="gold" class="anchored" data-anchor-id="empirical-plan-3">Empirical plan</h2>
<ol type="1">
<li><span class="gray">Estimate a discrete choice model based on the observed choices in rail cities</span></li>
<li><span class="gray">Use the estimated parameters to predict the mean choices on non-rail cities</span></li>
<li><span class="gray">Interpret the marginal effects and examine how different characteristics affect the probability of each choice</span></li>
<li><strong>Estimate the willingness to pay for different modes and characteristics</strong></li>
<li>Estimate the welfare gains/losses from introducing rail systems</li>
</ol>
</section>
</section>
<section id="willingness-to-pay" class="level1">
<h1>4. Willingness to pay</h1>
<section id="defining-willingness-to-pay" class="level2">
<h2 class="anchored" data-anchor-id="defining-willingness-to-pay">Defining willingness to pay</h2>
<p>A big advantage of having a characteristic that is measured in monetary value in the RUM framework is that we can use the model to derive WTP.</p>
<p>In this framework, the WTP of a choice characteristic is the corresponding change in monetary value to a change in a characteristic <em>that keeps the (indirect) utility level constant</em>.</p>
<p>Formally, let’s think about a model that has income entering an additive separably term in the indirect utility function</p>
<p><span class="math display">\[
V_{ik} = \alpha I_i + X_{ik}\beta_{ik}
\]</span></p>
<p>Parameter <span class="math inline">\(\alpha\)</span> here has a very important role: <strong>it defines the marginal utility of income</strong>.</p>
<hr>
<p>Then, for a change in some characteristics <span class="math inline">\(x_{ik,a}\)</span>, we have <span class="math display">\[
\begin{align}
dV &amp; = 0 \\
\alpha dI_i + \beta_{k,a} dx_{ik,a} &amp; = 0 \\
\frac{dI_i}{dx_{ik,a}} &amp; = -\frac{\beta_{k,a}}{\alpha}
\end{align}
\]</span></p>
<p>So, in exchange for a marginal increase in <span class="math inline">\(x_{ik,a}\)</span>, this individual is willing to trade-off up to <span class="math inline">\(\frac{\beta_{k,a}}{\alpha}\)</span> of their income (i.e., a compensating variation). This is the WTP!</p>
<hr>
<p>But what if we have prices but not income? That’s not an issue. That’s because the price paid to obtain a choice is itself a negative change in the individual’s income: <span class="math inline">\(dI = -dp\)</span></p>
<p>Therefore, we just reframe the indirect utility as <span class="math inline">\(V_{ik} = -\alpha p_k + X_{ik}\beta_{ik}\)</span> and all else is the same!</p>
<p>With that, we can easily calculate, for example, the mean WTP for an additional train stop:</p>
<p><span class="math display">\[
E\left[WTP_{\mbox{train stop}}\right] = \frac{\beta_{t,2}}{-\beta_{t,1}}
\]</span></p>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>α <span class="op">=</span> <span class="op">-</span>β_t_hat[<span class="fl">2</span>]</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>WTP_trainstop <span class="op">=</span> β_t_hat[<span class="fl">3</span>]<span class="op">/</span>α;</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"The mean WTP for an additional trainstop is </span><span class="sc">$</span>(<span class="fu">round</span>(WTP_trainstop<span class="op">*</span><span class="fl">100</span>, digits<span class="op">=</span><span class="fl">2</span>))<span class="st"> dollars/year per person."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The mean WTP for an additional trainstop is 24.62 dollars/year per person.</code></pre>
</div>
</div>
<p>Of course, you can do that with other product characteristics, too!</p>
</section>
<section id="empirical-plan-4" class="level2" data-background-color="gold">
<h2 data-background-color="gold" class="anchored" data-anchor-id="empirical-plan-4">Empirical plan</h2>
<ol type="1">
<li><span class="gray">Estimate a discrete choice model based on the observed choices in rail cities</span></li>
<li><span class="gray">Use the estimated parameters to predict the mean choices on non-rail cities</span></li>
<li><span class="gray">Interpret the marginal effects and examine how different characteristics affect the probability of each choice</span></li>
<li><span class="gray">Estimate the willingness to pay for different modes and characteristics</span></li>
<li><strong>Estimate the welfare gains/losses from introducing rail systems</strong></li>
</ol>
</section>
</section>
<section id="welfare-consequences" class="level1">
<h1>5. Welfare consequences</h1>
<p>With WTP estimates, we can calculate, for example, how much individuals who are riding the train would be willing to pay for expansions of the network. But it’s hard to think about how those chances would affect all individuals, including those that currently don’t choose trains. For instance, some might not be affected at all, while some might switch from cars or buses, thus willing to pay something for those changes.</p>
<p>Questions like these are addressed by taking a broader perspective based on welfare changes. (Since we don’t consider producer costs here, welfare will be essentially a measure of consumer surplus.)</p>
<p>To do that, we need to consider how changes in characteristics affect possibly the utility of all choices <span class="math inline">\(U_{ik}\)</span> and the total utility of an individual <span class="math inline">\(U_i\)</span></p>
<p><span class="math display">\[
U_i(X_i, \nu_{i}) = \max_{k=0,\dots,K} U_{ik}(X_{ik}, \nu_{ik}) = \max \left\{U_{i0}(X_{i0}, \nu_{i0}), \dots, U_{iK}(X_{iK}, \nu_{iK}) \right\}
\]</span></p>
<hr>
<p>In order to calculate the monetary value of a welfare change, we need to define the compensating variation relative to a change in characteristics from <span class="math inline">\(X_i\)</span> to <span class="math inline">\(\tilde{X}_i\)</span></p>
<p><span class="math display">\[
\max_{k=0,\dots,K} U(I_i - p_k, X_{ik}, \nu_{ik}) = \max_{k=0,\dots,K} U(I_i - CV_i - p_k, \tilde{X}_{ik}, \nu_{ik})
\]</span></p>
<p>However, calculating this <span class="math inline">\(CV\)</span> requires integrating over all idiosyncratic terms <span class="math inline">\(\nu\)</span>, which can be pretty difficult to solve.</p>
<hr>
<p>Luckily for us, the multinomial logit results in a nice closed-form expression!</p>
<p><span class="math display">\[
E[CV_i] = \frac{1}{\alpha}\left[\log\left(\sum_{k=1}^K e^{\tilde{X}_{ik}^\prime \beta_k}\right) - \log\left(\sum_{k=1}^K e^{X_{ik}^\prime \beta_k}\right)\right]
\]</span></p>
<p>So, it’s proportional to the log-difference of the denominator of the expression for choice probabilities!</p>
<hr>
<p>With the previous expression, we can now evaluate the change in individual consumer surplus from introducing the train option in the non-rail cities!</p>
<p><span class="math display">\[
E[\Delta CS] = \frac{1}{N} \sum_{i=1}^N \frac{1}{\alpha} \left[\underbrace{\log\left(1 + e^{V_{ib}} + e^{V_{it}} \right)}_{\mbox{With train}} - \underbrace{\log\left(1 + e^{V_{ib}} \right)}_{\mbox{Without train}}\right]
\]</span></p>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>denom_nr_withtrain <span class="op">=</span> <span class="fl">1.0</span> <span class="op">.+</span> <span class="fu">exp</span>.(V_b_hat_nr) <span class="op">.+</span> <span class="fu">exp</span>.(V_t_hat_nr);</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>denom_nr_notrain <span class="op">=</span> <span class="fl">1.0</span> <span class="op">.+</span> <span class="fu">exp</span>.(V_b_hat_nr)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>ΔCS <span class="op">=</span> <span class="fl">1</span><span class="op">/</span>α <span class="op">*</span> <span class="fu">mean</span>(<span class="fu">log</span>.(denom_nr_withtrain) <span class="op">-</span> <span class="fu">log</span>.(denom_nr_notrain));</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"The mean change in individual surplus from adding the train system is </span><span class="sc">$</span>(<span class="fu">round</span>(ΔCS<span class="op">*</span><span class="fl">100</span>, digits<span class="op">=</span><span class="fl">2</span>))<span class="st"> dollars/year per person."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The mean change in individual surplus from adding the train system is 17.19 dollars/year per person.</code></pre>
</div>
</div>
<p>Supposing the survey in non-rail systems were representative for a population of 2 million potential commuters, the total value of the train system would be about 34.4 million dollars per year!</p>
<p>Then, a benefit-cost analysis could compare the present value of this benefit over a number of years with the costs of implementing it.</p>
<section id="final-words" class="level2">
<h2 class="anchored" data-anchor-id="final-words">Final words</h2>
<ul>
<li>This tutorial walked you through all the steps of setting up a structural model and estimating it.</li>
<li>Combined with the first part, we:
<ul>
<li>Developed a model.</li>
<li>Simulated agent behavior consistent with the model.</li>
<li>Applied structural econometric methods to estimate the model.</li>
<li>Used the estimated model to perform economic analysis.</li>
</ul></li>
</ul>
<hr>
<ul>
<li>It is a great practice to follow these steps in any empirical work before you start actually working with the data.</li>
<li>One benefit is that it helps you think very carefully about what mechanisms your empirical model can capture and what it misses.</li>
<li>The big benefit here is that you can very transparently test whether your estimation procedure is robust to changes in the model underlying your assumptions.
<ul>
<li>For example, it’s easy now to add an omitted variable in the data and estimate the model ignoring it to see how bad the bias is.</li>
<li>Or change the distribution of tastes and see how it impacts your estimates.</li>
<li>Or whatever robustness check or and senstivity analysis you want to make.</li>
<li>The effect of these changes is often hard to anticipate, so having control over all the steps allows you to gauge their impacts and more easily establish how robust your empirical strategy is.</li>
</ul></li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>